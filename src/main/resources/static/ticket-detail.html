<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Detail | Helpdesk</title>
    <meta name="description" content="View ticket details, comments, and feedback">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <div class="page-loader">
        <div class="loader-spinner"></div>
    </div>
    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="app-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">üé´ HelpDesk</div>
                <div class="logo-sub">Ticketing System</div>
            </div>
            <ul class="sidebar-nav">
                <li><a href="dashboard.html" data-tooltip="Dashboard"><span class="nav-icon">üìä</span><span
                            class="nav-text">Dashboard</span></a></li>
                <li><a href="tickets.html" data-tooltip="Tickets"><span class="nav-icon">üé´</span><span
                            class="nav-text">Tickets</span></a></li>
                <li><a href="create-ticket.html" data-tooltip="Create Ticket"><span class="nav-icon">‚ûï</span><span
                            class="nav-text">Create Ticket</span></a></li>
                <li data-role="ADMIN"><a href="tickets.html?view=all" data-tooltip="All Tickets"><span
                            class="nav-icon">üìã</span><span class="nav-text">All Tickets</span></a>
                </li>
            </ul>
            <div class="sidebar-user">
                <div class="user-avatar">U</div>
                <div class="user-info">
                    <div class="user-name">User</div>
                    <div class="user-role">Role</div>
                </div>
                <button onclick="Auth.logout()" class="logout-btn" title="Logout">üö™</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="sidebar-toggle" id="sidebarToggle" title="Toggle sidebar">
                        <span class="toggle-icon">‚ò∞</span>
                    </button>
                    <h1 id="ticketTitle">Ticket Detail</h1>
                </div>
                <div class="top-bar-actions">
                    <button class="theme-toggle" onclick="ThemeManager.toggle()" title="Toggle dark mode"></button>
                    <a href="tickets.html" class="btn btn-outline btn-sm">‚Üê Back to Tickets</a>
                </div>
            </div>

            <!-- Ticket Info -->
            <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px" id="ticketLayout">
                <!-- Left Column -->
                <div>
                    <!-- Ticket Details Card -->
                    <div class="glass-card mb-3" id="ticketCard">
                        <div class="loader">
                            <div class="loader-spinner"></div>
                        </div>
                    </div>

                    <!-- Comments Section -->
                    <div class="glass-card">
                        <h3 style="margin-bottom:16px;font-weight:700">üí¨ Comments</h3>
                        <div id="commentsContainer">
                            <div class="loader">
                                <div class="loader-spinner"></div>
                            </div>
                        </div>
                        <div style="margin-top:20px;border-top:1px solid var(--border-color);padding-top:20px">
                            <div class="form-group">
                                <textarea class="form-control" id="commentInput" placeholder="Write a comment..."
                                    rows="3"></textarea>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="submitComment()">üí¨ Add Comment</button>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Actions & Info -->
                <div>
                    <!-- Status Actions (Admin/Agent) -->
                    <div class="glass-card mb-3" id="actionsCard" style="display:none">
                        <h3 style="margin-bottom:16px;font-weight:700">‚öôÔ∏è Actions</h3>

                        <div class="form-group" id="statusGroup">
                            <label class="form-label">Update Status</label>
                            <select class="form-control" id="statusSelect">
                                <option value="OPEN">Open</option>
                                <option value="IN_PROGRESS">In Progress</option>
                                <option value="ON_HOLD">On Hold</option>
                                <option value="RESOLVED">Resolved</option>
                                <option value="CLOSED">Closed</option>
                            </select>
                            <button class="btn btn-primary btn-sm mt-1 w-100" onclick="updateStatus()">Update
                                Status</button>
                        </div>

                        <div class="form-group" id="assignGroup" style="display:none">
                            <label class="form-label">Assign Agent (User ID)</label>
                            <input type="number" class="form-control" id="agentIdInput"
                                placeholder="Enter agent user ID">
                            <button class="btn btn-success btn-sm mt-1 w-100" onclick="assignAgent()">Assign
                                Agent</button>
                        </div>
                    </div>

                    <!-- Ticket Meta Info -->
                    <div class="glass-card mb-3" id="metaCard">
                        <h3 style="margin-bottom:16px;font-weight:700">üìã Info</h3>
                        <div id="metaInfo">Loading...</div>
                    </div>

                    <!-- Feedback Section -->
                    <div class="glass-card" id="feedbackCard" style="display:none">
                        <h3 style="margin-bottom:16px;font-weight:700">‚≠ê Rating & Feedback</h3>
                        <div id="feedbackContent"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Feedback Modal -->
    <div class="modal-overlay" id="feedbackModal">
        <div class="modal-content">
            <h2>‚≠ê Rate This Ticket</h2>
            <p style="color:var(--text-secondary);margin-bottom:20px">How was your experience with this ticket?</p>
            <div class="form-group">
                <label class="form-label">Rating</label>
                <div class="star-rating" id="starRating">
                    <input type="radio" name="rating" id="star5" value="5"><label for="star5">‚≠ê</label>
                    <input type="radio" name="rating" id="star4" value="4"><label for="star4">‚≠ê</label>
                    <input type="radio" name="rating" id="star3" value="3"><label for="star3">‚≠ê</label>
                    <input type="radio" name="rating" id="star2" value="2"><label for="star2">‚≠ê</label>
                    <input type="radio" name="rating" id="star1" value="1"><label for="star1">‚≠ê</label>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Comment (optional)</label>
                <textarea class="form-control" id="feedbackComment" placeholder="Share your feedback..."
                    rows="3"></textarea>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="submitFeedback()">Submit Feedback</button>
                <button class="btn btn-outline" onclick="closeFeedbackModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script src="/js/chatbot.js"></script>
    <script>
        if (!Auth.requireAuth()) throw new Error('Not authenticated');

        const ticketId = new URLSearchParams(window.location.search).get('id');
        if (!ticketId) { window.location.href = 'tickets.html'; }

        let currentTicket = null;

        async function loadTicket() {
            try {
                currentTicket = await API.get(`/tickets/${ticketId}`);
                renderTicket(currentTicket);
                loadComments();
                checkFeedback();
                setupActions();
            } catch (error) {
                Toast.error('Failed to load ticket');
            }
        }

        function renderTicket(t) {
            document.getElementById('ticketTitle').textContent = `Ticket #${t.id}`;
            document.title = `Ticket #${t.id} | Helpdesk`;

            document.getElementById('ticketCard').innerHTML = `
                <div class="d-flex justify-between items-center mb-2">
                    <h2 style="font-weight:800;font-size:1.3rem">${t.title}</h2>
                    ${getStatusBadge(t.status)}
                </div>
                <p style="color:var(--text-secondary);line-height:1.8;margin-bottom:16px;white-space:pre-wrap">${t.description}</p>
            `;

            document.getElementById('metaInfo').innerHTML = `
                <div style="display:flex;flex-direction:column;gap:12px">
                    <div><strong style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase">Status</strong><div style="margin-top:4px">${getStatusBadge(t.status)}</div></div>
                    <div><strong style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase">Priority</strong><div style="margin-top:4px">${getPriorityBadge(t.priority)}</div></div>
                    <div><strong style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase">Department</strong><div style="margin-top:4px">üè¢ ${t.departmentName}</div></div>
                    <div><strong style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase">Created By</strong><div style="margin-top:4px">üë§ ${t.creatorName}</div></div>
                    <div><strong style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase">Assigned Agent</strong><div style="margin-top:4px">üîß ${t.assignedAgentName || 'Not assigned'}</div></div>
                    <div><strong style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase">Created</strong><div style="margin-top:4px">üìÖ ${formatDate(t.createdAt)}</div></div>
                    <div><strong style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase">Updated</strong><div style="margin-top:4px">üìÖ ${formatDate(t.updatedAt)}</div></div>
                </div>
            `;

            // Show status selector
            if (document.getElementById('statusSelect')) {
                document.getElementById('statusSelect').value = t.status;
            }
        }

        function setupActions() {
            const role = Auth.getRole();
            if (role === 'ADMIN' || role === 'AGENT') {
                document.getElementById('actionsCard').style.display = 'block';
                if (role === 'ADMIN') {
                    document.getElementById('assignGroup').style.display = 'block';
                }
            }

            // Show feedback button for ticket owner when resolved/closed
            const user = Auth.getUser();
            if ((currentTicket.status === 'RESOLVED' || currentTicket.status === 'CLOSED')
                && currentTicket.creatorId === user.userId && !currentTicket.hasFeedback) {
                document.getElementById('feedbackCard').style.display = 'block';
                document.getElementById('feedbackContent').innerHTML = `
                    <p style="color:var(--text-secondary);margin-bottom:12px">Your ticket has been resolved! Please rate your experience.</p>
                    <button class="btn btn-primary w-100" onclick="openFeedbackModal()">‚≠ê Leave Feedback</button>
                `;
            }
        }

        async function loadComments() {
            try {
                const comments = await API.get(`/tickets/${ticketId}/comments`);
                const container = document.getElementById('commentsContainer');

                if (!comments.length) {
                    container.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px">No comments yet</p>';
                    return;
                }

                container.innerHTML = comments.map(c => `
                    <div class="comment-item">
                        <div class="comment-avatar">${c.authorName.charAt(0).toUpperCase()}</div>
                        <div class="comment-body">
                            <div class="comment-author">${c.authorName}</div>
                            <div class="comment-text">${c.message}</div>
                            <div class="comment-time">${formatDate(c.createdAt)}</div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load comments');
            }
        }

        async function submitComment() {
            const message = document.getElementById('commentInput').value.trim();
            if (!message) { Toast.warning('Please enter a comment'); return; }

            try {
                await API.post(`/tickets/${ticketId}/comments`, { message });
                document.getElementById('commentInput').value = '';
                Toast.success('Comment added');
                loadComments();
            } catch (error) {
                Toast.error('Failed to add comment');
            }
        }

        async function updateStatus() {
            const status = document.getElementById('statusSelect').value;
            try {
                await API.patch(`/tickets/${ticketId}/status?status=${status}`);
                Toast.success('Status updated to ' + status);
                loadTicket();
            } catch (error) {
                Toast.error('Failed to update status');
            }
        }

        async function assignAgent() {
            const agentId = document.getElementById('agentIdInput').value;
            if (!agentId) { Toast.warning('Enter an agent ID'); return; }

            try {
                await API.patch(`/tickets/${ticketId}/assign?agentId=${agentId}`);
                Toast.success('Agent assigned successfully');
                loadTicket();
            } catch (error) {
                Toast.error('Failed to assign agent');
            }
        }

        async function checkFeedback() {
            try {
                const fb = await API.get(`/tickets/${ticketId}/feedback`);
                if (fb) {
                    document.getElementById('feedbackCard').style.display = 'block';
                    const stars = '‚≠ê'.repeat(fb.rating) + '‚òÜ'.repeat(5 - fb.rating);
                    document.getElementById('feedbackContent').innerHTML = `
                        <div style="font-size:1.5rem;margin-bottom:8px">${stars}</div>
                        <p style="font-weight:600">${fb.userName}</p>
                        ${fb.comment ? `<p style="color:var(--text-secondary);margin-top:8px">"${fb.comment}"</p>` : ''}
                        <p style="color:var(--text-muted);font-size:0.8rem;margin-top:8px">${formatDate(fb.createdAt)}</p>
                    `;
                }
            } catch (e) {
                // No feedback yet ‚Äî that's fine
            }
        }

        function openFeedbackModal() {
            document.getElementById('feedbackModal').classList.add('open');
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.remove('open');
        }

        async function submitFeedback() {
            const ratingInput = document.querySelector('input[name="rating"]:checked');
            if (!ratingInput) { Toast.warning('Please select a rating'); return; }

            const rating = parseInt(ratingInput.value);
            const comment = document.getElementById('feedbackComment').value.trim();

            try {
                await API.post(`/tickets/${ticketId}/feedback`, { rating, comment: comment || null });
                Toast.success('Thank you for your feedback!');
                closeFeedbackModal();
                loadTicket();
            } catch (error) {
                Toast.error(error.message || 'Failed to submit feedback');
            }
        }

        loadTicket();
    </script>
</body>

</html>