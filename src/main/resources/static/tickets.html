<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tickets | Helpdesk</title>
    <meta name="description" content="View and manage your helpdesk tickets">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <div class="page-loader">
        <div class="loader-spinner"></div>
    </div>
    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="app-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">ğŸ« HelpDesk</div>
                <div class="logo-sub">Ticketing System</div>
            </div>
            <ul class="sidebar-nav">
                <li><a href="dashboard.html" data-tooltip="Dashboard"><span class="nav-icon">ğŸ“Š</span><span
                            class="nav-text">Dashboard</span></a></li>
                <li><a href="tickets.html" class="active" data-tooltip="Tickets"><span class="nav-icon">ğŸ«</span><span
                            class="nav-text">Tickets</span></a></li>
                <li><a href="create-ticket.html" data-tooltip="Create Ticket"><span class="nav-icon">â•</span><span
                            class="nav-text">Create Ticket</span></a></li>
                <li data-role="ADMIN"><a href="tickets.html?view=all" data-tooltip="All Tickets"><span
                            class="nav-icon">ğŸ“‹</span><span class="nav-text">All Tickets</span></a>
                </li>
            </ul>
            <div class="sidebar-user">
                <div class="user-avatar">U</div>
                <div class="user-info">
                    <div class="user-name">User</div>
                    <div class="user-role">Role</div>
                </div>
                <button onclick="Auth.logout()" class="logout-btn" title="Logout">ğŸšª</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="sidebar-toggle" id="sidebarToggle" title="Toggle sidebar">
                        <span class="toggle-icon">â˜°</span>
                    </button>
                    <h1>ğŸ« Tickets</h1>
                </div>
                <div class="top-bar-actions">
                    <button class="theme-toggle" onclick="ThemeManager.toggle()" title="Toggle dark mode"></button>
                    <a href="create-ticket.html" class="btn btn-primary">â• New Ticket</a>
                </div>
            </div>

            <!-- Filters -->
            <div class="filter-bar">
                <select class="form-control" id="filterStatus">
                    <option value="">All Status</option>
                    <option value="OPEN">Open</option>
                    <option value="IN_PROGRESS">In Progress</option>
                    <option value="ON_HOLD">On Hold</option>
                    <option value="RESOLVED">Resolved</option>
                    <option value="CLOSED">Closed</option>
                </select>
                <select class="form-control" id="filterPriority">
                    <option value="">All Priority</option>
                    <option value="LOW">Low</option>
                    <option value="MEDIUM">Medium</option>
                    <option value="HIGH">High</option>
                    <option value="URGENT">Urgent</option>
                </select>
                <select class="form-control" id="filterDepartment">
                    <option value="">All Departments</option>
                </select>
                <input type="date" class="form-control" id="filterStartDate" placeholder="Start Date">
                <input type="date" class="form-control" id="filterEndDate" placeholder="End Date">
                <button class="btn btn-primary btn-sm" onclick="applyFilters()">ğŸ” Filter</button>
                <button class="btn btn-outline btn-sm" onclick="clearFilters()">âœ• Clear</button>
            </div>

            <!-- Tickets Grid -->
            <div class="tickets-grid" id="ticketsGrid">
                <div class="loader">
                    <div class="loader-spinner"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/app.js"></script>
    <script src="/js/chatbot.js"></script>
    <script>
        if (!Auth.requireAuth()) throw new Error('Not authenticated');

        let allTickets = [];

        async function loadTickets() {
            try {
                const params = new URLSearchParams(window.location.search);
                const viewAll = params.get('view') === 'all';

                if (viewAll && Auth.getRole() === 'ADMIN') {
                    allTickets = await API.get('/tickets/all');
                } else {
                    allTickets = await API.get('/tickets');
                }
                renderTickets(allTickets);
            } catch (error) {
                Toast.error('Failed to load tickets');
            }
        }

        async function loadDepartments() {
            try {
                const depts = await API.get('/departments');
                const select = document.getElementById('filterDepartment');
                depts.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.id;
                    opt.textContent = d.name;
                    select.appendChild(opt);
                });
            } catch (e) { }
        }

        function renderTickets(tickets) {
            const grid = document.getElementById('ticketsGrid');
            if (!tickets.length) {
                grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">ğŸ“­</div><h3>No tickets found</h3><p>Try adjusting your filters or create a new ticket</p></div>';
                return;
            }
            grid.innerHTML = tickets.map((t, i) => `
                <div class="ticket-card" data-status="${t.status}" style="animation-delay:${i * 0.08}s"
                     onclick="window.location.href='ticket-detail.html?id=${t.id}'">
                    <div class="ticket-header">
                        <span class="ticket-id">#${t.id}</span>
                        ${getStatusBadge(t.status)}
                    </div>
                    <div class="ticket-title">${t.title}</div>
                    <div class="ticket-desc">${t.description}</div>
                    <div class="ticket-meta">
                        <span>${getPriorityBadge(t.priority)}</span>
                        <span>ğŸ¢ ${t.departmentName}</span>
                    </div>
                    <div class="ticket-meta mt-1">
                        <span>ğŸ‘¤ ${t.creatorName}</span>
                        <span>ğŸ“… ${formatDate(t.createdAt)}</span>
                    </div>
                    ${t.assignedAgentName ? `<div class="ticket-meta mt-1"><span>ğŸ”§ Agent: ${t.assignedAgentName}</span></div>` : ''}
                </div>
            `).join('');
        }

        async function applyFilters() {
            const status = document.getElementById('filterStatus').value;
            const priority = document.getElementById('filterPriority').value;
            const deptId = document.getElementById('filterDepartment').value;
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;

            let params = [];
            if (status) params.push(`status=${status}`);
            if (priority) params.push(`priority=${priority}`);
            if (deptId) params.push(`departmentId=${deptId}`);
            if (startDate) params.push(`startDate=${startDate}T00:00:00`);
            if (endDate) params.push(`endDate=${endDate}T23:59:59`);

            if (params.length === 0) {
                renderTickets(allTickets);
                return;
            }

            try {
                const filtered = await API.get(`/tickets/filter?${params.join('&')}`);
                renderTickets(filtered);
                Toast.info(`Found ${filtered.length} ticket(s)`);
            } catch (error) {
                Toast.error('Filter failed');
            }
        }

        function clearFilters() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterPriority').value = '';
            document.getElementById('filterDepartment').value = '';
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            renderTickets(allTickets);
        }

        loadTickets();
        loadDepartments();
    </script>
</body>

</html>